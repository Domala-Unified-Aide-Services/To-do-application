<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ To-Do List App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> My Tasks</h1>
            <p>Organize your day, achieve more</p>
        </div>

        <div class="add-task">
            <div class="add-task-row">
                <input type="text" id="taskInput" placeholder="What needs to be done?">
                <button class="submit-btn" onclick="addTask()"><i class="fas fa-plus"></i> Add Task</button>
            </div>
            <div class="priority-selector">
                <button class="priority-btn high" data-priority="high" onclick="selectPriority('high')">
                    <i class="fas fa-exclamation-circle"></i> High
                </button>
                <button class="priority-btn medium active" data-priority="medium" onclick="selectPriority('medium')">
                    <i class="fas fa-minus-circle"></i> Medium
                </button>
                <button class="priority-btn low" data-priority="low" onclick="selectPriority('low')">
                    <i class="fas fa-circle"></i> Low
                </button>
            </div>
        </div>
        
        <div class="task-filters">
            <div class="task-count" id="taskCount">0 items left</div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTasks('all')">All</button>
                <button class="filter-btn" onclick="filterTasks('active')">Active</button>
                <button class="filter-btn" onclick="filterTasks('completed')">Completed</button>
            </div>
        </div>
        
        <div class="task-list" id="taskList">
            <div class="empty-state" id="emptyState">
                <i class="far fa-check-circle"></i>
                <h3>No tasks yet</h3>
                <p>Add a task to get started!</p>
            </div>
        </div>
        
        <button class="clear-completed" onclick="clearCompleted()" id="clearCompletedBtn" style="display: none;">
            Clear completed tasks
        </button>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Task</h2>
                <button class="modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="text" id="editTaskInput" placeholder="Task title">
                <div class="priority-selector">
                    <button class="priority-btn high" data-priority="high" onclick="selectEditPriority('high')">
                        <i class="fas fa-exclamation-circle"></i> High
                    </button>
                    <button class="priority-btn medium" data-priority="medium" onclick="selectEditPriority('medium')">
                        <i class="fas fa-minus-circle"></i> Medium
                    </button>
                    <button class="priority-btn low" data-priority="low" onclick="selectEditPriority('low')">
                        <i class="fas fa-circle"></i> Low
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn save" onclick="saveEditTask()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let currentFilter = 'all';
        let selectedPriority = 'medium';
        let editingTaskId = null;
        let editingPriority = 'medium';
        
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            document.getElementById('taskInput').focus();
        });

        function selectPriority(priority) {
            selectedPriority = priority;
            document.querySelectorAll('.add-task .priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.add-task .priority-btn[data-priority="${priority}"]`).classList.add('active');
            console.log('Selected priority:', selectedPriority);
        }

        function selectEditPriority(priority) {
            editingPriority = priority;
            document.querySelectorAll('#editModal .priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#editModal .priority-btn[data-priority="${priority}"]`).classList.add('active');
            console.log('Selected edit priority:', editingPriority);
        }

        async function addTask() {
            const taskInput = document.getElementById('taskInput');
            const title = taskInput.value.trim();

            if (title === '') {
                taskInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    taskInput.style.animation = '';
                }, 500);
                return;
            }

            const addButton = document.querySelector('.add-task .submit-btn');
            const originalButtonText = addButton.innerHTML;
            addButton.disabled = true;
            addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            console.log('Adding task with priority:', selectedPriority);

            try {
                const response = await fetch('backend/api/add_task.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        title: title, 
                        completed: 0,
                        priority: selectedPriority
                    })
                });

                const data = await response.json();
                console.log('Add task response:', data);

                if (data.success) {
                    taskInput.value = '';
                    selectPriority('medium');
                    
                    // Add a small delay to ensure database is updated
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await loadTasks();
                    
                    // Scroll to bottom after render
                    await new Promise(resolve => setTimeout(resolve, 50));
                    const taskListEl = document.querySelector('.task-list');
                    taskListEl.scrollTop = taskListEl.scrollHeight;
                } else {
                    throw new Error(data.message || data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding task: ' + error.message);
            } finally {
                addButton.disabled = false;
                addButton.innerHTML = originalButtonText;
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch('backend/api/get_tasks.php');
                const data = await response.json();
                console.log('Loaded tasks:', data);
                console.log('Number of tasks:', data.tasks ? data.tasks.length : 0);
                tasks = data.tasks || [];
                
                // Log each task's completed status
                tasks.forEach(task => {
                    console.log(`Task ${task.id}: "${task.title}" - completed: ${task.completed} (type: ${typeof task.completed})`);
                });
                
                renderTasks();
                return tasks;
            } catch (error) {
                console.error('Error loading tasks:', error);
                return [];
            }
        }

        function updateTaskCount() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => isTaskCompleted(task)).length;
            const activeTasks = totalTasks - completedTasks;
            
            const taskCount = document.getElementById('taskCount');
            taskCount.textContent = `${activeTasks} item${activeTasks !== 1 ? 's' : ''} left`;
            
            const clearBtn = document.getElementById('clearCompletedBtn');
            clearBtn.style.display = completedTasks > 0 ? 'block' : 'none';
        }

        function filterTasks(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === filter);
            });
            
            document.querySelectorAll('.task-item').forEach(task => {
                const isCompleted = task.classList.contains('completed');
                const shouldShow = 
                    filter === 'all' ||
                    (filter === 'active' && !isCompleted) ||
                    (filter === 'completed' && isCompleted);
                
                task.style.display = shouldShow ? 'flex' : 'none';
            });
        }

        async function clearCompleted() {
            if (!confirm('Are you sure you want to clear all completed tasks?')) {
                return;
            }
            
            try {
                const response = await fetch('backend/api/delete_completed_tasks.php', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    await loadTasks();
                } else {
                    throw new Error(data.message || 'Failed to clear completed tasks');
                }
            } catch (error) {
                console.error('Error clearing completed tasks:', error);
                alert('Error: ' + error.message);
            }
        }

        function renderTasks() {
            const taskList = document.getElementById('taskList');
            
            if (!tasks || tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state" id="emptyState">
                        <i class="far fa-check-circle"></i>
                        <h3>No tasks yet</h3>
                        <p>Add a task to get started!</p>
                    </div>
                `;
                updateTaskCount();
                return;
            }
            
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            const sortedTasks = [...tasks].sort((a, b) => {
                if (isTaskCompleted(a) !== isTaskCompleted(b)) {
                    return isTaskCompleted(a) ? 1 : -1;
                }
                const aPriority = a.priority || 'medium';
                const bPriority = b.priority || 'medium';
                return priorityOrder[aPriority] - priorityOrder[bPriority];
            });
            
            taskList.innerHTML = '';
            
            sortedTasks.forEach(task => {
                const taskElement = document.createElement('div');
                const isCompleted = isTaskCompleted(task);
                const priority = task.priority || 'medium';
                taskElement.className = `task-item priority-${priority} ${isCompleted ? 'completed' : ''}`;
                taskElement.dataset.id = task.id;
                
                taskElement.innerHTML = `
                    <input type="checkbox" class="task-checkbox" 
                           onchange="toggleTask(${task.id}, this.checked)" 
                           ${isCompleted ? 'checked' : ''}>
                    <div class="task-content">
                        <span class="task-text">${escapeHtml(task.title)}</span>
                        <span class="priority-badge ${priority}">${priority}</span>
                        <div class="task-actions">
                            <button class="task-btn edit-btn" onclick="editTask(${task.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="task-btn delete-btn" onclick="deleteTask(${task.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                taskList.appendChild(taskElement);
            });
            
            filterTasks(currentFilter);
            updateTaskCount();
        }

        function isTaskCompleted(task) {
            return task.completed === true || task.completed === 1 || task.completed === '1';
        }

        async function toggleTask(id, completed) {
            console.log('Toggling task', id, 'to', completed);
            try {
                const response = await fetch(`backend/api/update_task.php?id=${id}&completed=${completed ? 1 : 0}`, {
                    method: 'GET'
                });
                
                const text = await response.text();
                console.log('Toggle response:', text);
                
                if (response.ok) {
                    await loadTasks();
                } else {
                    throw new Error('Failed to update task: ' + text);
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task: ' + error.message);
                await loadTasks();
            }
        }

        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            console.log('Deleting task', id);
            try {
                const response = await fetch(`backend/api/delete_task.php?id=${id}`, {
                    method: 'GET'
                });
                
                const text = await response.text();
                console.log('Delete response:', text);
                
                if (response.ok) {
                    await loadTasks();
                } else {
                    throw new Error('Failed to delete task: ' + text);
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task: ' + error.message);
            }
        }

        function editTask(id) {
            const task = tasks.find(t => t.id == id);
            if (!task) return;

            editingTaskId = id;
            editingPriority = task.priority || 'medium';
            
            document.getElementById('editTaskInput').value = task.title;
            selectEditPriority(editingPriority);
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingTaskId = null;
            editingPriority = 'medium';
        }

        async function saveEditTask() {
            const newTitle = document.getElementById('editTaskInput').value.trim();
            
            if (newTitle === '' || !editingTaskId) {
                return;
            }

            // Get the current task to preserve its completed status
            const currentTask = tasks.find(t => t.id == editingTaskId);
            console.log('Current task before edit:', currentTask);
            console.log('Saving task', editingTaskId, 'with priority:', editingPriority);

            const saveButton = document.querySelector('.modal-btn.save');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            try {
                const response = await fetch('backend/api/update_task_content.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: editingTaskId,
                        title: newTitle,
                        priority: editingPriority,
                        description: ''
                    })
                });

                const text = await response.text();
                console.log('Update response:', text);

                if (response.ok) {
                    try {
                        const data = JSON.parse(text);
                        if (data.success) {
                            closeEditModal();
                            // Add a small delay to ensure database is updated
                            await new Promise(resolve => setTimeout(resolve, 100));
                            await loadTasks();
                        } else {
                            throw new Error(data.error || 'Failed to update task');
                        }
                    } catch (e) {
                        // If response is not JSON, check if it's successful
                        if (text.includes('success')) {
                            closeEditModal();
                            await new Promise(resolve => setTimeout(resolve, 100));
                            await loadTasks();
                        } else {
                            throw new Error('Invalid response from server');
                        }
                    }
                } else {
                    throw new Error('Failed to update task: ' + text);
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task: ' + error.message);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        document.getElementById('editTaskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveEditTask();
            }
        });

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        console.log('To-Do List App initialized with priorities');
    </script>
</body>
</html>